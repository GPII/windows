/*
 * Windows Native Settings Handler
 *
 * Deals with individual settings that are only accessible throught isolated
 * API calls.
 *
 * Copyright 2018 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("gpii-universal"),
    gpii = fluid.registerNamespace("gpii"),
    windows = fluid.registerNamespace("gpii.windows");

require("../../WindowsUtilities/WindowsUtilities.js");

fluid.registerNamespace("gpii.windows.nativeSettingsHandler");

var hndName = "nativeSettingsHandler";

var GetDoubleClickTime = function () {
    var pRes = fluid.promise();

    pRes.resolve(windows.user32.GetDoubleClickTime());

    return pRes;
};

var SetDoubleClickTime = function (num) {
    var pRes = fluid.promise();

    var retVal = windows.user32.SetDoubleClickTime(num);
    if (retVal !== 0) {
        pRes.resolve();
    } else {
        var lastErr = windows.kernel32.GetLastError();
        var lastErrMsg = windows.translateLastError(lastErr);

        pRes.reject({code: lastErr, msg: lastErrMsg});
    }

    return pRes;
};

var functionNames = {
    DoubleClickTime: {
        set: SetDoubleClickTime,
        get: GetDoubleClickTime
    }
};

windows.nativeSettingsHandler.errorInfo = function (err) {
    return "With error - '" + JSON.stringify(err) + "'";
};

/**
 * Setter for the nativeSettingsHandler.
 *
 * The payload should have the following format:
 *
 * {
 *      "functionName": "FunctionName",
 *      "setParam": val
 * }
 *
 * The first two items:
 *   - function: Function name for the function to be used to set/get the value.
 *   - setParam: Parameter to be passed to the 'set' function.
 *
 * @param {object} payload The payload.
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.setImpl = function (payload) {
    var pRes = fluid.promise();

    var setFn = functionNames[payload.options.functionName].set;
    var getFn = functionNames[payload.options.functionName].get;

    var results = {};
    var settingsArray = fluid.makeArray(payload.settings);

    var uniqueSetting = settingsArray[0];
    // Get the payload value to set.
    var settingKey = fluid.keys(uniqueSetting)[0];
    var valueToSet = fluid.values(uniqueSetting)[0].value;

    // Create object for storing setting results.
    results[settingKey] = {};
    // Get the current values for the setting.
    var pGetOld = getFn();

    pGetOld.then(
        function (oldVal) {
            // Store the current value in results.
            fluid.set(results[settingKey], "oldValue.value", oldVal);

            var pSet = setFn(valueToSet);

            pSet.then(
                function () {
                    var pGetNew = getFn();

                    pGetNew.then(
                        function (newVal) {
                            fluid.set(results[settingKey], "newValue.value", newVal);

                            pRes.resolve(results);
                        },
                        function (err) {
                            var operation = ": Getting new value for setting '" + settingKey + "' failed.";
                            var getNewValErr = hndName + operation + windows.nativeSettingsHandler.errorInfo(err);

                            pRes.reject(getNewValErr);
                        }
                    );
                },
                function (err) {
                    var operation = ": Setting new value for setting '" + settingKey + "' failed.";
                    var setNewValErr = hndName + operation + windows.nativeSettingsHandler.errorInfo(err);

                    pRes.reject(setNewValErr);
                }
            );
        },
        function (err) {
            var operation = ": Getting current value for setting '" + settingKey + "' failed.";
            var getOldValErr = hndName + operation + windows.nativeSettingsHandler.errorInfo(err);

            pRes.reject(getOldValErr);
        },
    );

    return pRes;
};

/**
 * Getter for the nativeSettingsHandler.
 *
 * @param {object} payload The payload.
 */
windows.nativeSettingsHandler.getImpl = function (payload) {
    var pRes = fluid.promise();

    var getFn = functionNames[payload.options.functionName].get;

    var settingsArray = fluid.makeArray(payload.settings);
    var uniqueSetting = settingsArray[0];
    var results = {};

    // Get payload setting and prepare results for returning it
    var settingKey = fluid.keys(uniqueSetting)[0];
    results[settingKey] = {};

    var pGetRes = getFn();

    pGetRes.then(
        function (curVal) {
            results[settingKey].value = curVal;

            pRes.resolve(results);
        },
        function (err) {
            var operation = ": Getting current value for setting '" + settingKey + "' failed.";
            var getOldValErr = hndName + operation + windows.nativeSettingsHandler.errorInfo(err);

            pRes.reject(getOldValErr);
        }
    );

    return pRes;
};

/**
 * Invoke the settings handler.
 *
 * @param {object} payload The payload
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.get = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(windows.nativeSettingsHandler.getImpl, payload);
};

/**
 * Invoke the settings handler.
 *
 * @param {object} payload The payload
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.set = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(windows.nativeSettingsHandler.setImpl, payload);
};

fluid.defaults("fluid.transforms.fallbackValue", {
    gradeNames: ["fluid.transformFunction", "fluid.lens"]
});

/**
 * New transformation that lets you ignore a path if it's undefined, and supply another value instead.
 *
 * The input format for it should be the following:
 *
 * "transform": {
 *     "type": "fluid.transforms.fallbackValue",
 *     "inputPath": pathToValue,
 *     "outputPath": outputPathToStoreValue,
 *     "default": defaultValue
 * }
 *
 * Spec:
 *  - inputPath: The input path to test for nullity.
 *  - outputPath: The output path to put the result value from the transformation.
 *  - default: The default value to put in the "outputPath" in case of this being null.
 *
 * @param {object} transformSpec Transformation specification.
 * @param {*} transformer The transformer for the transformation.
 */
fluid.transforms.fallbackValue = function (transformSpec, transformer) {
    if (transformSpec.defaultValue === undefined) {
        fluid.fail("fallbackValue requires an fallback value named \"default\", supplied ", transformSpec);
    }
    var value = fluid.model.transform.getValue(transformSpec.inputPath, transformSpec.defaultInput, transformer);

    transformer.outputPrefixOp.push(transformSpec.outputPath);

    var outputValue = undefined;
    if (value === undefined) {
        outputValue = transformSpec.defaultValue;
        if (typeof(transformSpec.outputPath) === "string" && outputValue !== undefined) {
            fluid.model.transform.setValue(undefined, outputValue, transformer, transformSpec.merge);
            outputValue = undefined;
        }
    } else {
        outputValue = value;
        if (typeof(transformSpec.outputPath) === "string" && outputValue !== undefined) {
            fluid.model.transform.setValue(undefined, outputValue, transformer, transformSpec.merge);
            outputValue = undefined;
        }
    }
    transformer.outputPrefixOp.pop();

    return outputValue;
};

fluid.transforms.fallbackValue.collect = function (transformSpec, transformer) {
    var togo = [];
    fluid.model.transform.accumulateStandardInputPath("defaultInput", transformSpec, transformer, togo);
    fluid.each(transformSpec.match, function (option) {
        fluid.model.transform.accumulateInputPath(option.inputPath, transformer, togo);
    });
    return togo;
};
