/*!
Windows SystemParametersInfo Settings Handler

Copyright 2012 Antranig Basman
Copyright 2012 Astea Solutions AD

Licensed under the New BSD license. You may not use this file except in
compliance with this License.

You may obtain a copy of the License at
https://github.com/GPII/universal/blob/master/LICENSE.txt
*/

"use strict"; 

var ffi = require("node-ffi");
var fluid = require("universal");

var gpii = fluid.registerNamespace("gpii");
var windows = fluid.registerNamespace("gpii.windows");

var NULL = new ffi.Pointer(0);

// Guide to node-ffi types and conversions:
// https://github.com/rbranson/node-ffi/wiki/Node-FFI-Tutorial

var user32 = new ffi.Library('user32', {
	// http://msdn.microsoft.com/en-us/library/windows/desktop/ms724947(v=vs.85).aspx
	// UINT, UINT, PVOID, UINT; return type: BOOL
   'SystemParametersInfoW': [
      'int32', [ 'uint32', "uint32", 'pointer', 'uint32' ]
   ]
});

// http://msdn.microsoft.com/en-us/library/windows/desktop/dd318112(v=vs.85).aspx
windows.HighContrast = ffi.Struct([
	["uint32", "cbSize"],
	["uint32", "dwFlags"],
	["string", "lpszDefaultScheme"]
]);

// TODO Define additional structures used in calls to SystemParametersInfo here.

/**
 * Contains actions that can be used as the first argument of the SystemParametersInfo function.
 */ 
windows.actionConstants = {
	"SPI_GETHIGHCONTRAST": 0x0042,
	"SPI_SETHIGHCONTRAST": 0x0043
	// TODO Define additional actions used in calls to SystemParametersInfo here.
};

/**
 * Contains flags used in the "dwFlags" field of various structures
 * that are used in calls to the SystemParametersInfo function. 
 */
windows.flagConstants = {
	// HIGHCONTRAST flags
	// http://msdn.microsoft.com/en-us/library/windows/desktop/dd318112(v=vs.85).aspx
	"HCF_AVAILABLE": 0x00000002,
	"HCF_CONFIRMHOTKEY": 0x00000008,
	"HCF_HIGHCONTRASTON": 0x00000001,
	"HCF_HOTKEYACTIVE": 0x00000004,
	"HCF_HOTKEYAVAILABLE": 0x00000040,
	"HCF_HOTKEYSOUND": 0x00000010,
	"HCF_INDICATOR": 0x00000020
	// TODO Define additional flags that we need here.
};

/**
 * Contains structures that are used in calls to the SystemParametersInfo function,
 * accessible by their names. Used to dynamically instantiate the appropriate structure. 
 */
windows.structures = {
	"HIGHCONTRAST": windows.HighContrast
	// TODO Add additional structures that we need to instantiate here.
};

/**
 * Takes an array of flag names, applies binary OR among them and returns the result.
 * Used to supply the "dwFlags" argument of some structures.
 * 
 * @param {Array} flagNamesArray An array of flag names.
 *                These should be predefined in windows.flagConstants.
 */
windows.combineFlags = function (flagNamesArray) {
	var combinedFlags = 0;
	if (!(flagNamesArray instanceof Array)) {
		return 0;
	}
	for (var index in flagNamesArray) {
		combinedFlags = combinedFlags || windows.flagConstants[flagNamesArray[index]];
	}
	return combinedFlags;
};

/**
 * Entry point function of the component. Takes a payload as an input and sets the corresponding
 * settings using SystemParametersInfo. Returns an obejct containing the old and new values for each
 * of the settings.
 */
windows.spiSettingsHandler = function (payload) {
	// TODO Perform input data validation - e.g. whether the options correspond to the structure.
	var getAction = windows.actionConstants[payload.options.getAction];
	var setAction = windows.actionConstants[payload.options.setAction];
	var uiParam = payload.options.uiParam;
	var structName = payload.options.pvParamName;
	var results = {};
	for (var setting in payload.settings) {
		results[setting] = {};
		var oldValue = windows.getFlagValue(getAction, uiParam, structName, setting);
		results[setting].oldValue = oldValue;
	}
	// TODO Check what the value is in the payload before setting it. If it is false, it shouldn't be set.
	windows.setFlagValues(setAction, uiParam, structName, Object.keys(payload.settings));
	for (setting in payload.settings) {
		var newValue = windows.getFlagValue(getAction, uiParam, structName, setting);
		results[setting].newValue = newValue;
	}
	console.log(results);
	return results;
};

/**
 * Creates an empty structure with a given name. It should be registered in the
 * <code>windows.structures</code> map with that name. If the structure has a <code>cbSize</code>
 * member, the function sets that member to the size of the structure using <code>ffi.sizeof</code>.
 * 
 * @param {String} structName The name of the structure to create. Should be registered in the
 *                 <code>windows.structures</code> map.
 * @return {Object} The newly created structure with its <code>cbSize</code> member initialized.
 */
windows.createEmptyStructure = function (structName) {
	var struct = new windows.structures[structName]();
	if (struct.cbSize !== undefined) {
		struct.cbSize = ffi.sizeof(windows.structures[structName]);
	}
	return struct;
};

/**
 * Gets the value of a setting stored in the <code>dwFlags</code> member of a given structure.
 * Fails if the call to <code>SystemParametersInfo</code> does not succeed.
 * 
 * @param {Integer} action Corresponds to the <code>uiAction</code> parameter of the
 *                  <code>SystemParametersInfo</code> function.
 * @param {Integer} uiParam Corresponds to the <code>uiParam</code> parameter of the
 *                  <code>SystemParametersInfo</code> function.
 * @param {String} structName The name of the structure where the settings are stored.
 * @param {String} flagName The name of the flag whose value we need.
 * @return {Boolean} True if the flag is set in the <code>dwFlags</code> member of the structure,
 *                   false otherwise.
 */
windows.getFlagValue = function (action, uiParam, structName, flagName) {
	var pvParam = windows.createEmptyStructure(structName);
	var callSuccessful = user32.SystemParametersInfoW(action, uiParam, pvParam.ref(), 0);
	if (!callSuccessful) {
		fluid.fail("Could not get flag value with name " + flagName);
	}
	var flagValue = windows.flagConstants[flagName];
	if (flagValue === undefined) {
		fluid.fail("Structure " + structName + " does not contain a flag with name " + flagName + ".");
	}
	return (pvParam.dwFlags & flagValue) === flagValue;
};

/**
 * Sets the values of settings stored in the <code>dwFlags</code> member of a given structure.
 * 
 * @param {Integer} action Corresponds to the <code>uiAction</code> parameter of the
 *                  <code>SystemParametersInfo</code> function.
 * @param {Integer} uiParam Corresponds to the <code>uiParam</code> parameter of the
 *                  <code>SystemParametersInfo</code> function.
 * @param {String} structName The name of the structure where the settings are stored.
 * @param {Array} flagNames An array of flag names that need to be set to true.
 */
windows.setFlagValues = function (action, uiParam, structName, flagNames) {
	var pvParam = windows.createEmptyStructure(structName);
	var combinedFlags = windows.combineFlags(flagNames);
	pvParam.dwFlags = combinedFlags;
	var callSuccessful = user32.SystemParametersInfoW(action, uiParam, pvParam.ref(), 0);
	if (!callSuccessful) {
		fluid.fail("Could not set flag names " + flagNames + " in structure " + structName);
	}
	return pvParam;
};

// TODO Write a test
if (process.argv.length === 3) {
	var filename = __dirname + "/" + process.argv[2];
	// Note that this is now possible!
	// http://blog.gvm-it.eu/post/8175813806/node-js-0-5-2-load-json-files-with-require
	var jsonFile = require(filename);
	var returnCode = windows.spiSettingsHandler(jsonFile);
}
