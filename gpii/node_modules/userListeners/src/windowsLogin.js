/* Windows Login user listener.
 *
 * Copyright 2017 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("gpii-universal"),
    path = require("path"),
    edge = process.versions.electron ? require("electron-edge-js") : require("edge-js");

var gpii = fluid.registerNamespace("gpii");

// The proximity user listener
fluid.defaults("gpii.windows.userListeners.windowsLogin", {
    gradeNames: ["fluid.component", "gpii.userListener"],
    members: {
        listenerName: "windows-login"
    },
    invokers: {
        startListener: {
            funcName: "gpii.windows.userListeners.startWindowsLogin",
            args: ["{that}"]
        },
        stopListener: "fluid.identity",
        getGpiiKey: {
            funcName: "gpii.windows.userListeners.getGpiiKey",
            args: ["{that}", "{serviceHandler}.requestSender.sign"]
        }
    }
});

/**
 * Attempts a login, using the current Windows user account.
 *
 * @param {Component} that The gpii.windows.userListeners.proximity instance.
 * @return {Promise} Resolves when the listener has started.
 */
gpii.windows.userListeners.startWindowsLogin = function (that) {
    return that.getGpiiKey().then(function (gpiiKey) {
        that.events.onTokenArrive.fire(that, gpiiKey);
    });
};

/**
 * Function to sign some data.
 *
 * @callback windowsLogin.sign
 * @param {String|Buffer} payload The data to sign.
 * @param {String} keyName Key identifier (field name in the service's secrets file).
 * @return {Promise<String>} Resolves with the signed digest, as a 256bit hex string.
 */

/**
 * Generates a gpiiKey based on the current Windows user.
 *
 * The key is generated using the signed digest of the user's SID. The site's domain (stored in the service's secrets
 * file) is used to ensure gpii keys are unique across different deployments.
 *
 * @param {Component} that The gpii.windows.userListeners.proximity instance.
 * @param {windowsLogin.sign} sign The function used to sign the user id.
 * @return {Promise} Resolves when the listener has started.
 */
gpii.windows.userListeners.getGpiiKey = function (that, sign) {
    var promise = fluid.promise();

    var sid = gpii.windows.getUserSid();
    sign(sid, "site").then(function (digest) {
        // Truncate the digest into a guid.
        var result = gpii.windows.userListeners.hexToGuid(digest);
        promise.resolve(result);
    }, promise.reject);

    return promise;
};

/**
 * Mash a hex string (of at least 32 characters) into a GUID.
 * @param {String} hexString The input hex string.
 * @return {String} A guid, based on the given hex string.
 */
gpii.windows.userListeners.hexToGuid = function (hexString) {
    var result;
    if (hexString.length < 32) {
        fluid.fail("hexToGuid wants a longer string");
    } else {
        result = [
            hexString.substr(0, 8),
            hexString.substr(8, 4),
            hexString.substr(12, 4),
            hexString.substr(16, 4),
            hexString.substr(20, 12)
        ].join("-");
    }

    return result;
};

/**
 * Gets the current user's SID (security identifier) as a string. This is the unique identifier of a user on a domain.
 * For example: "S-1-5-21-2284820620-4150533183-3809465755-1001"
 *
 * @return {String} The SID of the currently logged in user.
 */
gpii.windows.getUserSid = function () {
    // Lazily initialise the .NET function, to save having to compile the assembly on start-up as it might not be used.
    if (!gpii.windows.getUserSidImpl) {
        gpii.windows.getUserSidImpl = edge.func({
            source: path.join(__dirname, "windowsLogin.cs"),
            typeName: "WindowsLogin",
            methodName: "GetUserSid",
            references: [
                "System.Runtime.dll"
            ]
        });
    }

    return gpii.windows.getUserSidImpl(null, true);
};
