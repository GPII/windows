/* PC/SC user listener.
 *
 * Copyright 2017 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The R&D leading to these results received funding from the
 * Department of Education - Grant H421A150005 (GPII-APCP). However,
 * these results do not necessarily represent the policy of the
 * Department of Education, and you should not assume endorsement by the
 * Federal Government.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("infusion");

var gpii = fluid.registerNamespace("gpii");
var Pcsclite = require("@pokusew/pcsclite");

fluid.registerNamespace("gpii.windows.userListeners");

fluid.defaults("gpii.userListeners.pcsc.windows", {
    gradeNames: ["fluid.component"],
    members: {
        proximity: true
    },
    invokers: {
        getPCSCLite: {
            funcName: "gpii.windows.userListeners.getPCSCLite"
        }
    }
});

/**
 * Gets a PCSCLite instance.
 *
 * @param that {Component} A gpii.pcscUserListener instance.
 * @return {PCSCLite} A new instance of PCSCLite, or null if there's no reader.
 */
gpii.windows.userListeners.getPCSCLite = function () {
    var pcscLiteInstance = null;
    // The library tries to start the Smart Card Windows service, SCardSvr (which causes a UAC prompt). This should be
    // already running if there's a reader attached - so, if the service isn't running then assume there is no card.
    var serviceState = gpii.windows.getServiceState("SCardSvr");
    if (serviceState === "running") {
        pcscLiteInstance = new Pcsclite();
    } else {
        fluid.log("SCardSvr service not running.");
    }

    return pcscLiteInstance;
};
