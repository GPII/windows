var fluid = require("universal");
var jqUnit = fluid.require("jqUnit");
var spiSH = require("../src/SpiSettingsHandler");
var windows = fluid.registerNamespace("gpii.windows");
var spi = fluid.registerNamespace("gpii.windows.spi");

jqUnit.module("SpiSettingsHandler Module");

var testPayloads = ["testFilterKeys", "testMouse", "testMouseClickLock", "testLogFont", "testNonClientMetrics", "testStickyKeys", "testHighContrast"];

fluid.each(testPayloads, function (name) {
    // TODO: currently these need to be fake async tests because of bug in our jqUnit implementation
    jqUnit.asyncTest("SpiSettingsHandler test - " + name, function () {
        var payload = require(__dirname + "/" + name);
        
        var expectedSettings = payload.settings;
        var expectedCount = 1;
        
        for (var property in expectedSettings) {
            expectedCount++;
        }
        jqUnit.expect(expectedCount);
        
        var oldSettings = windows.spiSettingsHandler.get(payload);
        var newSettings = spi.setOne(payload);
        
        for (var currentSetting in expectedSettings) {
            var expected = expectedSettings[currentSetting];
            
            jqUnit.assertDeepEq("Assert " + name + ": " + currentSetting, expected, newSettings[currentSetting].newValue);
            
            payload.settings[currentSetting].value = oldSettings[currentSetting];
        }
        
        spi.setOne(payload);
        
        jqUnit.assertDeepEq(name + " restored", oldSettings, windows.spiSettingsHandler.get(payload));
        setTimeout(jqUnit.start, 1);
    });
});
