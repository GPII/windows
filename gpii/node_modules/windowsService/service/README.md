# GPII Windows Service

A Windows Service that starts the GPII process (and listeners) when the user logs on, restarts it when it stops
unexpectedly, and provides the ability to run high-privileged tasks.

## Testing

The service can be ran as a normal process, without installing it.

```
node index.js
```

## Building

`npm install` will produce `bin/gpii-service.exe`. This bundles the node application into a standalone executable.

This what is invoked by the `Installer.ps1` scripts, and will be placed in `<installDir>\windows` when installed by the
installer.

## Installation

Running `gpii-service --install` (or `node index.js --install`) as administrator will install the service, which causes
it to start when the computer starts.

To start it immediately, run `net start gpii-service` as administrator.

This will also be performed by the MSI installer.

## Operation

### Command line options
```
 --install     Install the Windows Service.
 --serviceArgs=ARGS
         Comma separated arguments to pass to the service (use with --install).
 --uninstall   Uninstall the Windows Service.
 --service     Only used when running as a service.
 --config=FILE Specify the config file to use (default: service-config.json).
```

### Install the service
As administrator:
```
gpii-service --install
```

### Starting the service
As administrator:
```
net start gpii-service
```

### Stop and uninstall the service:
As administrator:
```
net stop gpii-service
gpii-service --uninstall
```

## Notes

## How it works

Services are slightly different to normal processes, the differences are handled by
[stegru/node-os-service#GPII-2338](https://github.com/stegru/node-os-service/tree/GPII-2338), which is a fork of
[node-os-service](https://github.com/stephenwvickers/node-os-service), where the service-related calls are made.

The service is started by Windows during the start up, then waits for a user to log in. (By listening for the
[SERVICE_CONTROL_SESSIONCHANGE](https://msdn.microsoft.com/library/windows/desktop/ms683241.aspx)
service control code).

When a user logs on, it starts the processes listed in [service-config.json](service-config.json) as that user and will
restart them if they die.


### Connectivity with GPII
Initial research: [stegru/service-poc](https://github.com/stegru/service-poc/blob/master/README.md)

