/*
 * WmiSetttingsHandler
 *
 * Copyright 2018 Raising the Floor - US
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("gpii-universal"),
    path = require("path"),
    edge = process.versions.electron ? require("electron-edge-js") : require("edge-js");

var gpii = fluid.registerNamespace("gpii");
var windows = fluid.registerNamespace("gpii.windows");

fluid.registerNamespace("gpii.windows.wmi");
fluid.registerNamespace("gpii.windows.wmiSettingsHandler");

/**
 * Merge two objects same keys into single one.
 *
 * @param {Object} objA First object which keys are going to be merged.
 * @param {Object} objN Second object which keys are going to be merged.
 * @returns {Array} Returns an array with the merged objects for the same keys.
 */
gpii.windows.wmi.mergeSameKeys = function (objA, objB) {
    var aKeys = Object.keys(objA);
    var bKeys = Object.keys(objB);

    var joinedKeys = {};
    fluid.each(aKeys, function (aKey) {
        fluid.each(bKeys, function (bKey) {
            if (aKey === aKey) {
                joinedKeys[aKey] = Object.assign({}, objA[aKey], objB[bKey]);
            }
        });
    });

    return joinedKeys;
};

/**
 * Replaces the placeholder "$value" used to mark the position of the
 * desired parameter in the paramaters that are goint to be supplied to
 * the function specified in the payload.
 *
 * @param {Array} queries The queries which placeholders are going to be replaced.
 * @returns {Array} The queries with the placeholders replaced.
 */
gpii.windows.wmi.replacePlaceholder = function (query) {
    var qKeys = Object.keys(query);
    var rQuery = {};

    fluid.each(qKeys, function (pKey) {
        var kSetting = query[pKey];
        var params = kSetting.set.params;
        var pIndex  = params.indexOf("$value");

        kSetting.set.params[pIndex] = kSetting.value;

        var pQuery = fluid.copy(kSetting);
        pQuery.set.params[pIndex] = kSetting.value;
        delete pQuery.value;

        rQuery[pKey] = pQuery;
    });

    return rQuery;
};

/**
 * @param {Object} queries The queries to be flatten into an array.
 * @returns {Object}
 */
gpii.windows.wmi.flatSetQuery = function (query) {
    var qKeys = Object.keys(query);

    var queries = [];
    fluid.each(qKeys, function (pKey) {
        var pValue = query[pKey];
        var arrayQuery = [];

        arrayQuery.push(pValue.namespace);
        arrayQuery.push(pValue.set.class);
        arrayQuery.push(pValue.set.method);
        arrayQuery.push(pValue.set.params);

        queries.push(arrayQuery);
    });

    return queries;
};

/**
 * @param {Object} queries The queries to be flatten into a set array.
 * @returns {Object}
 */
gpii.windows.wmi.flatGetQuery = function (query) {
    var qKeys = Object.keys(query);

    var queries = [];
    fluid.each(qKeys, function (pKey) {
        var pValue = query[pKey];
        var arrayQuery = [];

        arrayQuery.push(pValue.namespace);
        arrayQuery.push(pValue.get.query);

        queries.push(arrayQuery);
    });

    return queries;
};

windows.wmi.preparePayload = function (settings, options) {
    var queries = windows.wmi.mergeSameKeys(settings, options);
    var rQueries = windows.wmi.replacePlaceholder(queries);

    return rQueries;
};

var updateQuery = edge.func({
    source: path.join(__dirname, "..\\dotNetSrc\\updateWMISetting.cs"),
    references: ["System.Management.dll"]
});

windows.wmi.updateWMISetting = function (query) {
    var result;

    try {
        result = updateQuery(query, true);
    } catch (error) {
        console.log("windows.wmi.updateWMISetting: Failed with error - '" + error + "'");
    }

    return result;
};

/**
 * Makes a query to modify a WMI setting with the payload information. The payload format
 * should have the following schema:
 *  {
 *      "className": "WmiClassName",
 *      "methodName": "WmiClassMethodName",
 *      "params": ["MethodParameters"],
 *      "returnSpec": ["ReturnType", "ExpectedResult"]
 *  }
 *
 * @param {Object} payload The payload with the information to set the desired setting.
 */
gpii.windows.wmi.setImpl = function (rQueries) {
    var results = {};

    var setQueries = windows.wmi.flatSetQueries(rQueries);
    var getQueries = windows.wmi.flatGetQuery(rQueries);
    var getResults = gpii.windows.wmi.getImpl(getQueries);

    var results = {};
    results["oldValue"] = fluid.copy(getResults.value);

    fluid.each(setQueries, function (query) {
        var result = gpii.wmiSettingsHandler.updateQuery(query);

        if (result === false) {
            fluid.fail("WmiSettingsHandler: Failed to set setting with WMI payload - '" + JSON.stringify(query) + "'" );
        }
    });
    getResults = gpii.windows.wmi.getImpl(getQueries);
    results["newValue"] = fluid.copy(getResults.value);

    return results;
};

/**
 * Makes a query to modify a WMI setting with the payload information. The payload format
 * should have the following schema:
 *  {
 *      "className": "WmiClassName",
 *      "methodName": "WmiClassMethodName",
 *      "params": ["MethodParameters"],
 *      "returnSpec": ["ReturnType", "ExpectedResult"]
 *  }
 *
 *  "com.microsoft.windows.brightness": [
 *      {
 *           "settings": {
 *               "Brightness": {
 *                   "value": 100
 *               }
 *           },
 *           "options": {
 *               "Brightness": {
 *                   "namespace": "root\\WMI",
 *                   "get": {
 *                       "query": "SELECT CurrentBrightness FROM WmiMonitorBrightness"
 *                   },
 *                   "set": {
 *                       "class": "WmiMonitorBrightnessMethods",
 *                       "method": "WmiSetBrightness",
 *                       "params": [
 *                           4294967295,
 *                           "$value"
 *                       ]
 *                   }
 *               }
 *           }
 *       }
 *   ]
 * @param {Object} payload The payload with the information to set the desired setting.
 */
gpii.windows.wmiSettingsHandler.set = function (payload) {
    var settings = payload.settings;
    var options = payload.options;

    var settingValueIndex = options.params.indexOf("$value");

    if (settingValueIndex == -1) {
        fluid.fail("Error: Invalid payload format. No value placeholder supplied.")
    } else {
        var rQueries = windows.wmi.preparePayload(settings, options);
        return gpii.settingsHandlers.invokeSettingsHandler(gpii.windows.wmi.setImpl, rQueries);
    }
};

var getQuery = edge.func({
    source: path.join(__dirname, "..\\dotNetSrc\\queryWMISetting.cs"),
    references: ["System.Management.dll"]
});

windows.wmi.getQuery = function (query) {
    var result;

    try {
        result = getQuery(query, true);
    } catch (error) {
        console.log("windows.wmi.getQuery: Failed with error - '" + error + "'");
    }

    return result;
};

gpii.windows.wmi.getImpl = function (rQueries) {
    var results = {
        value: []
    };

    var getQueries = windows.wmi.flatGetQuery(rQueries);

    fluid.each(getQueries, function (query) {
        results.value.push(windows.wmi.getQuery(query));
    });

    return results;
};

gpii.windows.wmiSettingsHandler.get = function (payload) {
    var settings = payload.settings;
    var options = payload.options;

    var settingValueIndex = options.params.indexOf("$value");

    if (settingValueIndex == -1) {
        fluid.fail("Error: Invalid payload format. No value placeholder supplied.")
    } else {
        var rQueries = gpii.windows.wmi.preparePayload(settings, options);

        return gpii.settingsHandlers.invokeSettingsHandler(gpii.windows.wmi.getImpl, rQueries);
    }
};
