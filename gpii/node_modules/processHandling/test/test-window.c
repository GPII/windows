/*
 * test-window.c: Simple application that creates a window, used to test closeProcessByName.
 *
 * How to build:
 *  Start "Visual C++ 2015 x86 Native Build Tools Command Prompt"
 *    or run: %comspec% /k ""C:\Program Files (x86)\Microsoft Visual C++ Build Tools\vcbuildtools.bat"" x86
 *  Compile with: cl test-window.c
 *
 * Copyright 2016 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */


#include <Windows.h>
#include <stdio.h>
#pragma comment (lib, "User32.lib")


/* Creates a window and message pump, returns when the window closes. */
int window() {
    // Create the window
    HWND wnd = CreateWindowEx(0, TEXT("STATIC"), TEXT("GPII-TEST-WINDOW"), 0, 0, 0, 0, 0, NULL, NULL, GetModuleHandle(NULL), NULL);

    if (!wnd) {
        printf("CreateWindowEx Error: %i", GetLastError());
        return 1;
    }

    // Set a timer for 1 minute.
#define TIMER_ID 2
    SetTimer(wnd, TIMER_ID, 60000, NULL);

    printf("test-window: Window created (hwnd:%u, pid:%u)\n", (unsigned int)wnd, GetCurrentProcessId());
    // Flush the output - the unit test is waiting for this text.
    fflush(stdout);

    MSG msg;
    BOOL ret;
    // Handle the messages.
    while ((ret = GetMessage(&msg, NULL, 0, 0)) != 0) {
        if (ret == -1) {
            printf("GetMessage Error: %i", GetLastError());
            return 1;
        }

        TranslateMessage(&msg);
        DispatchMessage(&msg);

        if (msg.hwnd == wnd) {
            switch (msg.message) {
                case WM_TIMER:
                    if (msg.wParam == TIMER_ID) {
                        puts("test-window: Timeout");
                        KillTimer(wnd, TIMER_ID);
                        PostQuitMessage(0);
                    }
                    break;
                case WM_QUERYENDSESSION:
                    puts("message: WM_QUERYENDSESSION");
                    break;
                case WM_ENDSESSION:
                    puts("message: WM_ENDSESSION");
                    break;
            }
        }
        fflush(stdout);
    }

    puts("message: WM_QUIT");
    puts("test-window: Ended");
    return msg.wParam;
}

int main(int argc, char **argv)
{
    if ((argc > 1) && !stricmp("-window", argv[1])) {
        return window();
    }

    puts("A simple application that creates a window that lasts 60 seconds.\n");
    puts(" -window       Create a Window.");

    return 0;
}
