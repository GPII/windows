    /*
 * Tests for the Windows 10 Desktop Background Settings Handler
 *
 * Copyright 2018 Raising the Floor - US
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("gpii-universal"),
    jqUnit = require("node-jqunit"),
    path = require("path"),
    fs = require("fs");

var gpii = fluid.registerNamespace("gpii"),
    windows = fluid.registerNamespace("gpii.windows"),
    handler = fluid.registerNamespace("gpii.windows.desktopBackground");

require("../src/desktopBackgroundSettingsHandler.js");

jqUnit.module("desktopBackgroundSettingsHandler Module");
fluid.registerNamespace("gpii.tests.windows.desktopBackground");

fluid.logObjectRenderChars = 1000000;

jqUnit.test("Testing 'set' request building for systemSettingsHandler", function () {
    jqUnit.expect(1);
    var mode = "set";

    var slideShowPayload = {
        BackgroundType: {
            value: "Slideshow"
        },
        Input: {
            value: {
                Shuffle: true
            }
        }
    };

    var slideShowRequest = {
        settings: {
            SystemSettings_Personalize_Background_ChooseBackground: {
                value: "Slideshow"
            },
            SystemSettings_Personalize_Background_SlideshowShuffle: {
                value: true
            }
        }
    };

    jqUnit.assertDeepEq("Slideshow payload", slideShowRequest, handler.buildSystemSettingsRequest(slideShowPayload, mode));
});

jqUnit.test("Testing 'get' request building for systemSettingsHandler", function () {
    jqUnit.expect(1);
    var mode = "get";

    var slideShowPayload = {
        BackgroundType: {
            value: "Slideshow"
        },
        Input: {
            value: {
                Shuffle: true
            }
        }
    };

    var slideShowRequest = {
        settings: {
            SystemSettings_Personalize_Background_ChooseBackground: {},
            SystemSettings_Personalize_Background_SlideshowShuffle: {}
        }
    };

    jqUnit.assertDeepEq("Slideshow payload", slideShowRequest, handler.buildSystemSettingsRequest(slideShowPayload, mode));
});

jqUnit.asyncTest("Set desktop wallpaper using spiSettingsHandler", function () {
    jqUnit.expect(2);

    var curWallpaper = handler.getDeskWallpaper();
    var sysFolder =  "C:\\Windows\\Web\\Wallpaper\\Theme1";
    var curName = path.basename(curWallpaper);

    fs.readdir(sysFolder, function (err, items) {
        if (err) {
            jqUnit.fail("Problem while reading wallpapers directory content");
            jqUnit.start();
        } else {
            var newName = items.find(function (item) { return (item !== curName) && (path.extname(item) === ".jpg"); });
            if (newName === undefined) {
                jqUnit.fail("Not able to find another picture to replace actual wallpaper");
                jqUnit.start();
            } else {
                var newWallpaper = path.join(sysFolder, newName);

                handler.setDeskWallpaper(newWallpaper).then(
                    function () {
                        jqUnit.assert("Wallpaper set correctly");

                        if (curWallpaper === "") {
                            jqUnit.assert("Recovered original wallpaper");
                            jqUnit.start();
                        } else {
                            handler.setDeskWallpaper(curWallpaper).then(
                                function () {
                                    jqUnit.assert("Recovered original wallpaper");
                                    jqUnit.start();
                                },
                                function () {
                                    jqUnit.fail("Failed to recover original wallpaper");
                                    jqUnit.start();
                                }
                            );
                        }
                    },
                    function () {
                        jqUnit.fail("Error while setting wallpaper");
                        jqUnit.start();
                    }
                );
            }
        }
    });
});

jqUnit.test("Test setting system colors for desktop", function () {
    jqUnit.expect(3);

    var newColor = { r: 96, g: 85, b: 78 };
    var curColor = windows.getSolidColor();

    var setColorRes = windows.setSolidColor(newColor);
    jqUnit.assertTrue("setSolidColor: Should return 'true'", setColorRes);

    var newSettedColor = windows.getSolidColor();
    jqUnit.assertDeepEq("setSolidColor: Color should be now the new setted color", newColor, newSettedColor);

    // Restore previous system color
    var restRes = windows.setSolidColor(curColor);
    jqUnit.assertTrue("Restoring original system color should succeed", restRes);
});

gpii.tests.windows.desktopBackground.getAndSet = function (getRequest, newSettings) {
    var curValues = handler.getImpl(getRequest);
    var pSet = handler.setImpl(newSettings);

    pSet.then(
        function () {
            var newRequest = { settings: curValues, options: {} };
            var recP = handler.setImpl(newRequest);

            recP.then (
                function () {
                    jqUnit.assert("Successfully setted and recovered settings.");
                    jqUnit.start();
                },
                function (err) {
                    jqUnit.fail(err);
                    jqUnit.start();
                }
            );
        },
        function (err) {
            jqUnit.fail(err);
            jqUnit.start();
        }
    );
};

jqUnit.asyncTest("Testing desktopBackgroundSettingsHandler setter functionality with 'SolidColor' payload", function () {
    jqUnit.expect(1);

    var solidColorSettings =
        {
            settings: {
                BackgroundType: {
                    value: "SolidColor"
                },
                Input: {
                    value: {
                        Color: { r: 67, g: 187, b: 19 }
                    }
                }
            },
            options: {}
        };
    var getSolidColor =
        {
            settings: {
                BackgroundType: {}
            },
            options: {}
        };

    gpii.tests.windows.desktopBackground.getAndSet(getSolidColor, solidColorSettings);
});

jqUnit.asyncTest("Tesing desktopBackgroundSettingsHandler setter functionality with 'Picture' payload", function () {
    jqUnit.expect(1);

    var pictureSettings =
        {
            settings: {
                BackgroundType: {
                    value: "Picture"
                },
                Input: {
                    value: {
                        Image: "C:\\Windows\\Web\\Wallpaper\\Theme1\\img1.jpg",
                        Scaling: "Fill"
                    }
                }
            },
            options: {}
        };
    var getPicture =
        {
            settings: {
                BackgroundType: {
                    value: "Picture"
                },
                Input: {
                    value: {
                        Scaling: undefined,
                        Image: undefined
                    }
                }
            },
            options: {}
        };

    gpii.tests.windows.desktopBackground.getAndSet(getPicture, pictureSettings);
});

jqUnit.asyncTest("Testing desktopBackgroundSettingsHandler setter functionality with 'Slideshow' payload", function () {
    jqUnit.expect(1);

    var slideshowSettings =
        {
            settings: {
                BackgroundType: {
                    value: "Slideshow"
                },
                Input: {
                    value: {
                        Shuffle: true
                    }
                }
            },
            options: {}
        };
    var getSlideshow =
        {
            settings: {
                BackgroundType: {
                    value: "Slideshow"
                },
                Input: {
                    value: {
                        Shuffle: undefined
                    }
                }
            },
            options: {}
        };

    gpii.tests.windows.desktopBackground.getAndSet(getSlideshow, slideshowSettings);
});
