/*
 * Monitor brightness support for Windows
 *
 * Copyright 2016 Raising the Floor - US
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */
"use strict";

var fluid = require("universal");
var edge = require("edge");

var windows = fluid.registerNamespace("gpii.windows");

fluid.registerNamespace("gpii.windows.display");

var isBrightnessSupported = edge.func({
    source: function () {/*
    using System;
    using System.Threading.Tasks;
    using System.Management;

    public class Startup {
        public async Task<object> Invoke(object input) {
            // Define scope (namespace)
            ManagementScope scope = new ManagementScope("root\\WMI");
            // Define query
            SelectQuery query = new SelectQuery("SELECT * FROM WmiMonitorBrightness");

            ManagementObjectSearcher searcher = new ManagementObjectSearcher(scope, query);

            ManagementObjectCollection objectCollection = searcher.Get();

            if (objectCollection.Count == null) {
                return false;
            } else {
                return true;
            }
            return false;
        }
    }
    */},
    references: ["System.Management.dll"]
});

windows.wmi.isBrightnessSupported = function () {
    try {
        var res = isBrightnessSupported(null, true);
        return res;
    } catch(error) {
        if (error.ErrorCode === "NotSupported") {
            return false;
        } else {
            fluid.fail("windows.wmi.isBrightnessSupported: Unknown error");
        }
    }
};

var getBrightness = edge.func({
    source: function () {/*
    using System;
    using System.Threading.Tasks;
    using System.Management;

    public class Startup {
        public async Task<object> Invoke(object input) {
            // Define scope (namespace)
            ManagementScope scope = new ManagementScope("root\\WMI");
            // Define query
            SelectQuery query = new SelectQuery("SELECT * FROM WmiMonitorBrightness");

            object itemRes = null;
            ManagementObjectSearcher searcher = new ManagementObjectSearcher(scope, query);
            ManagementObjectCollection objectCollection = searcher.Get();
            foreach (ManagementObject mObj in objectCollection) {
                foreach (var item in mObj.Properties) {
                    if(item.Name =="CurrentBrightness") {
                        itemRes = item.Value;
                    }
                }
            }
            return itemRes;
        }
    }
    */},
    references: ["System.Management.dll"]
});


windows.wmi.getScreenBrightness = function () {
    var result;

    try {
        result = getBrightness(null, true);
    } catch(error) {
        if (error.ErrorCode === "NotSupported") {
            fluid.fail("windows.wmi.setBrightness: Is not supported in this environmment.");
        } else {
            fluid.fail("windows.wmi.setBrightness: Failed.");
        }
    }

    return result;
};

var setBrightness = edge.func({
    source: function () {/*
        using System;
        using System.Threading.Tasks;
        using System.Management;

        public class Startup {
            public async Task<object> Invoke(object input) {
                // Define scope (namespace)
                ManagementScope s = new ManagementScope("root\\WMI");
                // Define query
                SelectQuery q = new SelectQuery("WmiMonitorBrightnessMethods");

                ManagementObjectSearcher mos = new ManagementObjectSearcher(s, q);

                ManagementObjectCollection moc = mos.Get();

                object res = null;

                foreach (ManagementObject mObj in moc) {
                    res = mObj.InvokeMethod("WmiSetBrightness", new Object[] { UInt32.MaxValue, input }) as uint?;
                    break;
                }

                if (res == null) {
                    return  0;
                } else {
                    return res;
                }
            }
        }
    */},
    references: ["System.Management.dll"]
});

windows.wmi.setScreenBrightness = function (value) {
    var result;

    try {
        result = setBrightness(value, true);
    } catch(error) {
        if (error.ErrorCode === "NotSupported") {
            fluid.fail("windows.wmi.setBrightness: Is not supported in this environmment.");
        } else {
            fluid.fail("windows.wmi.setBrightness: Failed with error: '" + error.message + "'");
        }
    }

    return result;
};
