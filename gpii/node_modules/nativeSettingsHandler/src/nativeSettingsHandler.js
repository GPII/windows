/*
 * Windows Native Settings Handler
 *
 * Deals with individual settings that are only accessible throught isolated
 * API calls.
 *
 * Copyright 2018 Raising the Floor - International
 *
 * Licensed under the New BSD license. You may not use this file except in
 * compliance with this License.
 *
 * The research leading to these results has received funding from the European Union's
 * Seventh Framework Programme (FP7/2007-2013)
 * under grant agreement no. 289016.
 *
 * You may obtain a copy of the License at
 * https://github.com/GPII/universal/blob/master/LICENSE.txt
 */

"use strict";

var fluid = require("gpii-universal"),
    gpii = fluid.registerNamespace("gpii"),
    windows = fluid.registerNamespace("gpii.windows");

require("../../WindowsUtilities/WindowsUtilities.js");

fluid.registerNamespace("gpii.windows.nativeSettingsHandler");

/**
 * Gets the current double click time for mouse.
 *
 * @return {Promise} The current system double click time for mouse.
 */
windows.nativeSettingsHandler.GetDoubleClickTime = function () {
    var result = windows.user32.GetDoubleClickTime();

    return fluid.toPromise(result);
};

/**
 * Sets the current double click time for mouse.
 *
 * @param {Number} num The double click time to set in the system.
 * @return {Promise} Object with the error information.
 */
windows.nativeSettingsHandler.SetDoubleClickTime = function (num) {
    var pRes = fluid.promise();

    var retVal = windows.user32.SetDoubleClickTime(num);
    if (retVal !== 0) {
        pRes.resolve();
    } else {
        var lastErr = windows.kernel32.GetLastError();
        var lastErrMsg = windows.translateLastError(lastErr);

        pRes.reject({code: lastErr, msg: lastErrMsg});
    }

    return pRes;
};

/**
 * Sets the width of the double-click rectangle.
 *
 * @param {Number} num The number to be set as the width of the double-click rectangle.
 * @return {Promise} Object with the error information.
 */
windows.nativeSettingsHandler.SetDoubleClickWidth = function (num) {
    var pRes = fluid.promise();

    var retVal = gpii.windows.spi.systemParametersInfo("UINT", gpii.windows.spi.actions.SPI_SETDOUBLECLKWIDTH, num, 0, 0);

    if (retVal === 0) {
        var lastErr = windows.kernel32.GetLastError();
        var lastErrMsg = windows.translateLastError(lastErr);

        pRes.reject({code: lastErr, msg: lastErrMsg});
    } else {
        pRes.resolve(retVal);
    }

    return pRes;
};

/**
 * Gets the current width of the double-click rectangle.
 *
 * @return {Promise} The current value of the width for the double-click rectangle.
 */
windows.nativeSettingsHandler.GetDoubleClickWidth = function () {
    var result = windows.user32.GetSystemMetrics(windows.API_constants.SM_CXDOUBLECLK);

    return fluid.toPromise(result);
};

/**
 * Sets the height of the double-click rectangle.
 *
 * @param {Number} num The number to be set as the height of the double-click rectangle.
 * @return {Promise} Object with the error information.
 */
windows.nativeSettingsHandler.SetDoubleClickHeight = function (num) {
    var pRes = fluid.promise();

    var retVal = gpii.windows.spi.systemParametersInfo("UINT", gpii.windows.spi.actions.SPI_SETDOUBLECLKHEIGHT, num, 0, 0);

    if (retVal === 0) {
        var lastErr = windows.kernel32.GetLastError();
        var lastErrMsg = windows.translateLastError(lastErr);

        pRes.reject({code: lastErr, msg: lastErrMsg});
    } else {
        pRes.resolve(retVal);
    }

    return pRes;
};

/**
 * Gets the current height of the double-click rectangle.
 *
 * @return {Promise} The current value of the height for the double-click rectangle.
 */
windows.nativeSettingsHandler.GetDoubleClickHeight = function () {
    var result = windows.user32.GetSystemMetrics(windows.API_constants.SM_CYDOUBLECLK);

    return fluid.toPromise(result);
};

windows.nativeSettingsHandler.functions = {
    DoubleClickTime: {
        set: windows.nativeSettingsHandler.SetDoubleClickTime,
        get: windows.nativeSettingsHandler.GetDoubleClickTime
    },
    DoubleClickWidth: {
        set: windows.nativeSettingsHandler.SetDoubleClickWidth,
        get: windows.nativeSettingsHandler.GetDoubleClickWidth
    },
    DoubleClickHeight: {
        set: windows.nativeSettingsHandler.SetDoubleClickHeight,
        get: windows.nativeSettingsHandler.GetDoubleClickHeight
    }
};

/**
 * Helper function that converts a error to string, so the rejection from the
 * settings handler only holds a message.
 *
 * @param {Object} err The error to be stringified.
 * @return {String} The error message.
 */
windows.nativeSettingsHandler.errorInfo = function (err) {
    return "With error - '" + JSON.stringify(err) + "'";
};

/**
 * Helper function for creating a custom message for error rejection.
 *
 * @param {Promise} promise The promise to be rejected.
 * @param {String} settingKey The name of the requested setting for which an operation failed.
 * @param {Object} err The error object.
 * @param {String} message A message with information about the operation.
 */
windows.nativeSettingsHandler.reject = function (promise, settingKey, err, message) {
    var operation = message + settingKey + "' failed.";
    var errMsg = "nativeSettingsHandler" + operation + windows.nativeSettingsHandler.errorInfo(err);

    promise.reject(errMsg);
};

/**
 * Setter for the nativeSettingsHandler.
 *
 * The payload should have the following format:
 *
 * {
 *      "functionName": "FunctionName",
 *      "setParam": val
 * }
 *
 * The first two items:
 *   - function: Function name for the function to be used to set/get the value.
 *   - setParam: Parameter to be passed to the 'set' function.
 *
 * @param {Object} payload The payload.
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.setImpl = function (payload) {
    var pRes = fluid.promise();

    var fnName = fluid.get(payload, "options.functionName");
    var setFn = fluid.get(windows.nativeSettingsHandler.functions, fnName + ".set");
    var getFn = fluid.get(windows.nativeSettingsHandler.functions, fnName + ".get");
    var fnNotDef = [": Failed due to '", " " + fnName + "' function not being defined."];

    if (setFn === undefined) {
        pRes.reject("nativeSettingsHandler" + fnNotDef[0] + "set" + fnNotDef[1]);
    } else if (getFn === undefined) {
        pRes.reject("nativeSettingsHandler" + fnNotDef[0] + "get" + fnNotDef[1]);
    } else {
        var results = {};
        var settingsArray = fluid.makeArray(payload.settings);

        if (settingsArray.length === 0) {
            pRes.reject("nativeSettingsHandler: Failed due to empty payload.");
        } else {
            var uniqueSetting = settingsArray[0];
            // Get the payload value to set.
            var settingKey = fluid.keys(uniqueSetting)[0];
            var valueToSet = fluid.values(uniqueSetting)[0].value;

            // Create object for storing setting results.
            results[settingKey] = {};
            // Get the current values for the setting.
            var pGetOld = getFn();

            pGetOld.then(
                function (oldVal) {
                    // Store the current value in results.
                    fluid.set(results[settingKey], "oldValue.value", oldVal);

                    var pSet = setFn(valueToSet);

                    pSet.then(
                        function () {
                            var pGetNew = getFn();

                            pGetNew.then(
                                function (newVal) {
                                    fluid.set(results[settingKey], "newValue.value", newVal);

                                    pRes.resolve(results);
                                },
                                function (err) {
                                    windows.nativeSettingsHandler.reject(pRes, settingKey, err, ": Getting new value for setting '");
                                }
                            );
                        },
                        function (err) {
                            windows.nativeSettingsHandler.reject(pRes, settingKey, err, ": Setting new value for setting '");
                        }
                    );
                },
                function (err) {
                    windows.nativeSettingsHandler.reject(pRes, settingKey, err, ": Getting current value for setting '");
                }
            );
        }
    }

    return pRes;
};

/**
 * Getter for the nativeSettingsHandler.
 *
 * @param {Object} payload The payload.
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.getImpl = function (payload) {
    var pRes = fluid.promise();

    var fnName = fluid.get(payload, "options.functionName");
    var getFn = fluid.get(windows.nativeSettingsHandler.functions, fnName + ".get");
    var fnNotDef = [": Failed due to '", " " + fnName + "' function not being defined."];

    if (getFn === undefined) {
        pRes.reject("nativeSettingsHandler" + fnNotDef[0] + "get" + fnNotDef[1]);
    } else {
        var settingsArray = fluid.makeArray(payload.settings);

        if (settingsArray.length === 0) {
            pRes.reject("nativeSettingsHandler: Failed due to empty payload.");
        } else {
            var uniqueSetting = settingsArray[0];
            var results = {};

            // Get payload setting and prepare results for returning it
            var settingKey = fluid.keys(uniqueSetting)[0];
            results[settingKey] = {};

            var pGetRes = getFn();

            pGetRes.then(
                function (curVal) {
                    results[settingKey].value = curVal;

                    pRes.resolve(results);
                },
                function (err) {
                    windows.nativeSettingsHandler.reject(pRes, settingKey, err, ": Getting current value for setting '");
                }
            );
        }
    }

    return pRes;
};

/**
 * Invoke the settings handler.
 *
 * @param {Object} payload The payload
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.get = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(windows.nativeSettingsHandler.getImpl, payload);
};

/**
 * Invoke the settings handler.
 *
 * @param {Object} payload The payload
 * @return {Promise} Resolves with the response.
 */
windows.nativeSettingsHandler.set = function (payload) {
    return gpii.settingsHandlers.invokeSettingsHandler(windows.nativeSettingsHandler.setImpl, payload);
};
